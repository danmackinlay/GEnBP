# Gaussian Ensemble Belief Propagation

A method for handling high-dimensional inference with simualtors.
Think: working out how to calibrate your climate model using staellite images.
For a casual introduction, see [this blog post](https://danmackinlay.name/notebook/genbp/).

Experiments from the paper are generated by the notebooks whose names start with `mp_`.

Development was supported by the [CSIRO MLAI Future Science Platform](https://github.com/csiro-mlai/).

## Run experiments from the paper

`ipython` or `jupyter` is required to run the notebooks.

```ipython
%run mp_026a_factor_graph_sysid_advection_sanity.py
%run mp_026b_factor_graph_sysid_advection_d.py
%run mp_026c_factor_graph_sysid_advection_n_ens.py
%run mp_030b_factor_graph_sysid_ns2d_d.py
%run mp_030c_factor_graph_sysid_ns2d_n_ens.py
%run mp_030d_factor_graph_sysid_ns2d_visc.py
```

## Installation

This step should work for users on Linux, Macos.
It should also work for Windows users via the free Microsoft extension, [Windows Subsystem for Linux (WSL)](https://danmackinlay.name/notebook/wsl.html):

```bash
git clone https://github.com/danmackinlay/prob_operator_2023.git
cd prob_operator_2023
```

Now, install the requirements.
Local desktop:

```bash
python3 -m venv --prompt probop ./venv
source ./venv/bin/activate  # linux or macos, bash-like
pip install -r requirements.txt
python -m ipykernel install --user --name=probop  # for jupyter
```

## Run experiments from the paper

`ipython` or `jupyter` is required to run the notebooks.

```ipython
%run mp_026a_factor_graph_sysid_advection_sanity.py
%run mp_026b_factor_graph_sysid_advection_d.py
%run mp_026c_factor_graph_sysid_advection_n_ens.py
%run mp_030b_factor_graph_sysid_ns2d_d.py
%run mp_030c_factor_graph_sysid_ns2d_n_ens.py
%run mp_030d_factor_graph_sysid_ns2d_visc.py
```


## Further reading

* The paper [[2402.08193] Gaussian Ensemble Belief Propagation for Efficient Inference in High-Dimensional Systems](https://arxiv.org/abs/2402.08193)
* Joe Ortizâ€™ GaBP implementations

  * [Gaussian Belief Propagation Library](https://colab.research.google.com/drive/1-nrE95X4UC9FBLR0-cTnsIP_XhA_PZKW?usp=sharing) in torch

## TODO

### Next paper

* [ ] radical refactor of code to make inference graphs easier to construct
* [ ] make it easier to set up nodes with comparable priors between GaBP and GEnBP.
* [ ] nodes need to ask their parent factor graph for their adjacent nodes by name otherwise it is very difficult to add nodes to the graph.
* [ ] ancestral *factors*, possibly virtual, should be conformed, not ancestral *variables.*
* [ ] revisit `get_ens_or_obs` which is a mess. How better to provide values for ancestral vars?
* [ ] Non-Gaussian (e.g. Huber) factors
* [ ] Complex-valued low-rank factors, or otherwise signed
* [ ] pre-normalisation of sim values to be comparable scale
* [ ] solve lstsq using CGD, via [KernelSolve](https://www.kernel-operations.io/keops/python/api/pytorch/KernelSolve.html)


## Useful commands

Delete old logs

24 hours ago:
```bash
find ./_logs -type f -mtime +1 -exec rm {} \;
```

12 hours ago
```bash
find ./_logs
 -type f -mmin +720 -exec rm {} \;
```
